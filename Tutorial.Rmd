---
title: "Interaktives Lerntutorial Data Science"
output: learnr::tutorial
runtime: shiny_prerendered
---

```{r setup, include=FALSE}
#load packages
library(learnr)
library(readxl)
library(tidyverse)
library(DT)
library(shiny)
library(plotly)
library(dplyr)

#load dataset
titanic <- read_xlsx("Titanic.xlsx")

#code checking
checker<-function(label,user_code,check_code,envir_result,evaluate_result,...){
  list(message = check_code,correct = TRUE, location = "append")
}
tutorial_options(exercise.timelimit = 10, exercise.checker = checker)


```

## Datenbasis

### Der Datensatz

Der in unserem Tutorial verwendete Datensatz stammt von der Website [Kaggle](https://www.kaggle.com/) und enthält Informationen über die Passagiere der Titanic.
Der Datensatz ist weit verbreitet und wird oft für das Training von KI und Machine-Learning genutzt ([Titanic Dataset](https://www.kaggle.com/datasets/sakshisatre/titanic-dataset/data)).

Die Merkmale welche im Datensatz verwendet werden sind folgende:

* Klasse
* Überlebt (1=Ja, 0=Nein)
* Name
* Geschlecht
* Alter
* Anzahl der Geschwister und Ehepartner auf dem Schiff
* Anzahl der Eltern auf dem Schiff
* Ticketnummer
* Ticketpreis
* Kabinennummer
* Zustiegshafen (Kürzel)
* Nummer des Rettungsboots (wenn überlebt)
* ID-Der Leiche (wenn gestorben)
* Herkunft

Hier ein Ausschnitt aus der Tabelle:

```{r view head, echo = FALSE}
datatable(titanic, options = list(pageLength = 5, scrollX = TRUE))
```

### Hypothesen

Folgende Hypothesen haben wir aufgestellt und wollen diese im Verlauf dieses Tutorials Überprüfen:

* Die Wahrscheinlichkeit als Frau zu überleben ist höher, als als Mann.
* Die Wahrscheinlichkeit zu überleben steigt mit der Wertigkeit der gebuchten Klasse.
* Die Wahrscheinlichkeit zu überleben sinkt mit dem Anstieg des Alters.


## Datenaufbereitung


### Einlesen der Daten

Um die Daten aus einer Excel-Datei zu lesen, verwenden wir die 'readxl'-Bibliothek.
```{r readdata}
titanic <- read_xlsx("Titanic.xlsx")
```
Für eine CSV-Datei würde der Befehl so lauten:<br>
*titanic <- read_csv("Titanic.csv")*

Die Daten einer Erhebung werden in der Regel als **Rohdaten** oder **Urlisten** bezeichnet und wurden noch nicht bearbeitet.<br>
Bei einer **Vollerehebung** werden bei der Datenerhebung alle statistischen Einheiten einer Grundgesamtheit erfasst. 
Da dies in den meisten Fällen nicht möglich ist, erfolgt eine **Teilerhebung** in Form einer **Stichprobe**.<br>
Dies ist auch hier der Fall gewesen.


### Inkonsistenzen und Leerstellen beheben

Da Rohdaten häufig unvollständig, inkonsistent oder fehlerbehaftet sind, muss im ersten Schritt eine **Datenbereinigung** stattfinden. 
Hierbei werden die Daten vorverarbeitet und somit verändert, aufgefüllt oder auch gelöscht. <br>
Was in einem konkreten Fall sinnvoll ist, hängt vom Datentyp, der Anwendung und Fragestellung ab.<br>
Bekannte Beispiele für Dateninkonsistenzen sind Datumsangaben oder Länderbezeichnungen. Wo Datumsangaben bei unterschiedlichen Formaten mit Tools wie Excel oder R automatisch angepasst werden können, bedürfen Länderbezeichnungen oft manueller oder halbautomatische Lösungen.

Eine besondere Aufmerksamkeit gilt auch dem Umgang mit fehlenden Daten, die sowohl bei selbst erhobenen, als auch bei extern bezogenen Datenquellen auftreten können.<br>
Hierbei gibt es zwei gängige Methoden, fehlende Daten zu handhaben:

#### Ausschluss von Daten

Die einfachste Möglichkeit im Umgang mit fehlenden Daten ist der Ausschluss von Beobachtungen mit fehlenden Daten.
Dabei muss zuerst entschieden werden, welche Merkmale besonders wichtig für den Datensatz sind und welche nach möglichkeit keine **NULL-Werte** enthalten sollten.

Welche von den vorherigen genannten Merkmalen könnten in unserem Datensatz besonders relevant sein (auch im Hinblick auf unsere Hypothesen)?

```{r quiz1, echo=FALSE}
question("Bitte wähle alle Merkmale aus, welche du für notwendig hältst.",
         answer("Klasse", correct = TRUE, message = "Korrekt, das Merkmal 'Klasse' ist notwendig um die zweite Hypothese zu überprüfen."),
         answer("Überlebt", correct = TRUE, message = "Da sich der Datensatz und unsere Hypothesen alle um das Überleben drehen, ist das Merkmal 'überlebt' auch zwingend notwendig."),
         answer("Name", message = "* Name"),
         answer("Geschlecht", correct = TRUE, message = "Auch das 'Geschlecht' wird benötigt, da hiermit die erste Hypothese überprüft werden kann."),
         answer("Alter", correct = TRUE, message = "Letzten Endes benötigen wir noch das 'Alter', um die dritte Hypothese zu überprüfen."),
         answer("Anzahl der Geschwister und Ehepartner auf dem Schiff", message = "* Anzahl der Geschwister und Ehepartner auf dem Schiff"),
         answer("Anzahl der Eltern auf dem Schiff", message = "* Anzahl der Eltern auf dem Schiff"),
         answer("Ticketnummer", message = "* Ticketnummer"),
         answer("Ticketpreis", message = "* Ticketpreis"),
         answer("Kabinennummer", message = "* Kabinennummer"),
         answer("Zustiegshafen", message = "* Zustiegshafen"),
         answer("Nummer des Rettungsboots", message = "* Nummer des Rettungsboots"),
         answer("ID-Der Leiche", message = "* ID-Der Leiche"),
         answer("Herkunft", message = "* Herkunft"),
         type = "multiple",
         incorrect = "Folgende Merkmale sind nicht notwendig:"
         )
```
Da wir nun alle wichtigen Merkmale identifiziert haben, können wir uns darum kümmern, den Datensatz zu bereinigen.
Hierfür bereinigen wir erst alle Einträge, welche keine Angaben bei unseren wichtigen Mermalen enthalten.
Da der Datensatz von Natur aus keine NULL-Werte in den Spalten "überlebt", "Klasse" und "Geschlecht" enthält, müssen wir das nur noch für das Mermal "Alter" tun.

Hierfür legen wir als erstes eine neue Tabelle mit dem Namen "titanic_clean" an:<br>

```{r copy table}
titanic_clean <- titanic
```

Anschließend entfernen wir mit Hilfe einer Filter-Funktion alle Zeilen mit NULL-Werten beim "Alter":<br>

```{r delete missing}
titanic_clean <- titanic_clean %>%
  filter(!is.na(age))

datatable(titanic_clean, options = list(pageLength = 5, scrollX = TRUE))
```

Wie zu erkennen ist, hat die Tabelle nun einige Seiten weniger und es sind keine NULL-Werte mehr beim "Alter" vorhanden.
Als nächstes wollen wir noch alle unrealistischen Einträge entfernen. Hierfür beschränken wir uns wieder nur auf das "Alter", da dieses leicht einzuschätzen ist und die anderen wichtigen Merkmale keine fehlerhaften Werte enthalten.<br>
Versuchen Sie nun alle Einträge mit einem höheren "Alter" als 100 zu entfernen. Der korrekte Name der Spalte ist dabei "age".

```{r delete_unrealistic_age, exercise = TRUE, excercise.eval = FALSE}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter()

datatable(titanic_cleanTask, options = list(pageLength = 5, scrollX = TRUE))
```

```{r delete_unrealistic_age-solution}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)

datatable(titanic_cleanTask, options = list(pageLength = 5, scrollX = TRUE))
```
<br>
Wunderbar! Nun haben wir eine Tabelle, welche keine Fehlerhaften und unbrauchbaren Daten mehr enthält.<br>

```{r new titanic_clean, include = FALSE}
titanic_clean <- titanic_clean %>%
  filter(!is.na(age)) %>%
  filter(age < 101)

datatable(titanic_clean, options = list(pageLength = 5, scrollX = TRUE))
```

#### Imputation

Die andere Methode ist es, fehlende Daten durch "sinnvolle" Daten zu ersetzen. Hierbei werden am einfachsten Lagemaße wie Mittelwert, Median oder Modus als "sinnvolle" Werte verwendet. Aufwendigere Verfahren arbeiten mit speziellen Schätzern, die beispielsweise Regressionsverfahren verwenden.
<br>
<br>
Für eine Zusammenfassung, wie die Datenaufbereitung in R funktioniert, kannst du dir dieses Video anschauen:<br>
<iframe width="560" height="315" src="https://www.youtube.com/embed/FcxiSwZcPvw?si=JeCbEg15XfJXCG5z" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>

## Datenanalyse

Da wir nun die Bereinigung erfolgreich durchgeführt haben, können wir mit der Datenanalyse fortfahren.
Im weitern Verlauf werden wir die "titanic_clean"-Tabelle nutzen, da diese entsprechend der Aufgabe aus dem letzten Kapitel bereinigt wurde.

### Mittelwert

Der **Mittelwert** dient, wie der Name bereits sagt der Ermittlung des Durchschnittswerts eines Merkmals. Eine alternative Bezeichnung wäre das arithmetisches Mittel. Um den Mittelwert zu berechnen werden alle Daten einer Datenreihe addiert und anschließend durch die Anzahl der Beobachtungswerte geteilt.<br>
In R kann der Mittelwert mit der "mean()"-Funktion berechnet werden. Dafür müssen aber vorerst die Werte des entsprechenden Merkmals extrahiert werden. Wir nehmen dafür wieder das "Alter".

```{r extract age}
alter <- titanic_clean$age
```

Anschließend können wir den Mittelwert berechnen.

```{r mittelwert}
mean(alter)
```

### Median

Der **Median** eines Datensatzes stellt den Wert dar, welcher genau in der Mitte liegt. Bei einer nach Größe sortierten Datenreihe wäre das der Wert, welcher sowohl links als auch rechts von sich gleich viele Werte hat. Darum wird der Median auch als Zentralwert bezeichnet.<br>
Die Berechnung des Medians in R erfolgt über die median()-Funktion.<br>
Bitte lies wieder das "Alter" aus dem bereinigten Datensatz aus und berechne den Median.

```{r median, exercise = TRUE, exercise.eval = FALSE}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)
```
```{r median-hint}
variable <- Datensatz$merkmal 
"Welche Funktion benötige ich für die Berechnung des Medians?"

```
```{r median-solution}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)
alter <- titanic_cleanTask$age
median(alter)
```

### Varianz

Die **Varianz** beschreibt ein Maß, das die Streuung der Werte eines Merkmals definiert - anders gesagt wie stark unterscheiden sich die Werte.<br> Eine höhere Varianz bedeutet, dass die Werte eines ausgesuchten Merkmals weiter auseinander liegen, während man aus einer niedrigen Varianz folgern kann, dass die Werte näher am Mittelwert liegen. Die Varianz ist allerdings nicht normiert weswegen es schwer zu berurteilen ist, ob diese groß oder klein ist. Eine Möglichkeit dies besser zu beurteilen ist die **Standardabweichung**<br>
Die Berechnung der Varianz erfolgt über die **var(subset)-Funktion**.
Bitte ließ wieder das "Alter" aus dem bereinigten Datensatz aus und berechne damit die Varianz.

```{r variance, exercise = TRUE, exercise.eval = FALSE}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)
```

```{r variance-hint}
variable <- Datensatz$merkmal 
"Welche Funktion benötige ich für die Berechnung der Varianz?"

```


```{r variance-solution}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)
alter <- titanic_cleanTask$age
var(alter)
```


### Standardabweichung

Die **Standardabweichung** ist wie die Varianz ein Maß, dass die Streuung der Werte eines Merkmals definiert. Dieses Maß beschreibt in diesem Fall die durchschnittliche Streuung um den Mittelwert. Dieses Maß lässt sich auf in R auf mehrere weißen bestimmen.<br>
Eine Möglichkeit ist die bestimmung mithilfe der Varianz. Die Standardabweichung ist definiert als die Wurzel aus der Varianz. Die zweite Möglichkeit ist die verwendung der **sd(subset)-Funktion** (**S**tandard **D**eviation).
Bitte ließ wieder das "Alter" aus dem bereinigten Datensatz ein und berechne dann die Standardabweichung

```{r sd, exercise = TRUE, exercise.eval = FALSE}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)
```

```{r sd-hint}
variable <- Datensatz$merkmal 
"Welche Funktion benötige ich für die Berechnung der Standardabweichung?"

```

```{r sd-solution}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)
alter <- titanic_cleanTask$age
sd(alter)
```

```{r sd-check}
"Super! Mit der Standardabweichung kannst du überprüfen ob das Alter tatsächlich durchschnittlich um +-14 Jahre vom Mittelwert 30 Jahre abweicht"
```

### Lineare Regression

**Lineare Regression** wird verwendet, um eine Beziehung zwischen einer **abhängigen Variable (Kriterium)** und einer **unabhängigen Variable (Prädiktoren)** vorherzusagen.<br>
Ein Beispiel: Man könnte die Hypothese aufstellen, das Kinder und junge Erwachsene weniger Zahlen als ältere Personen.<br>
Wir wollen also überprüfen, ob das Kriterium - der Ticket-Preis, abhängig vom Alter - der Prädiktoren ist. Dafür können wir beide werte ersteinmal in ein Diagramm eintragen.

```{r diagrammForLR}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)

alter <- titanic_cleanTask$age
gezahlt <- titanic_cleanTask$fare
plot(gezahlt ~ alter,xlab="Alter der Person",ylab="Ticket Preis", main="Streudiagramm Alter - TicketPreis",pch=20)
```

FÜr die Überprüfung des Zusammenhangs können wir dann eine sogennante **Regressionsgerade** benutzen. Da es sich hierbei um eine lineare Regression handelt hat diese die form y = bx + c.<br>
Dabei ist y der Kriteriumswert also der, den wir später vohersagen wollen und x der Prädiktorwert.<br>
Für die Berechnung der Regressionsgeraden gibt es jetzt wieder zwei Möglichkeiten.<br>
Die einfache Variante ist die Verwendung der in R eingebundenen **lm(subset ~ subset) Funktion**.<br>
Mithilfe der **abline(data, col="gewünschteFarbe")-Funktion** kann diese dann ausgegeben werden.
Füge in das untere Diagramm eine solche Regressionsgerade ein.

```{r diagrammForLRUser, exercise = TRUE, exercise.eval = FALSE}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)

alter <- titanic_cleanTask$age
gezahlt <- titanic_cleanTask$fare

plot(gezahlt ~ alter,xlab="Alter der Person",ylab="Ticket Preis", main="Streudiagramm Alter - TicketPreis",pch=20)

```
```{r diagrammForLRUser-hint}
"z  <- lm(y~x)
abline(z,col=Farbe)"
```

```{r diagrammForLRUser-solution}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)

alter <- titanic_cleanTask$age
gezahlt <- titanic_cleanTask$fare

plot(gezahlt ~ alter,xlab="Alter der Person",ylab="Ticket Preis", main="Streudiagramm Alter - TicketPreis",pch=20)

regression <- lm(alter ~ gezahlt)
abline(regression, col="red",lwd=5)

```

Mithilfe dieser Gerade kannst du überprüfen, ob deine Hypothese wahr ist.<br>
Für den zweiten Weg nutzen wir die Geradengleichung und brechnen die b und c werte. Der Vorteil dieser Methode ist es, das du auch ohne grafischen Plot deine Hypothese prüfen kannst. Denn ist der b Wert in der Geradengleichung positiv steigt diese und deine Hypothese wäre somit korrekt. Ist dieser negativ sinkt diese und deine Hypothese wäre falsch.<br>
Für die Berechnung brauchst du die **Mittelwerte** die **Standardabweichungen** und die **Korrelation** beider Merkmale. 

### Korrelation
Die **Korrelation** kann den zusammenhang zwischen zwei Variablen bestimmen. Dabei lässt sich folgendes folgern:<br>
Wenn der Korrelationskoeffizient positiv ist, sind die beiden Variablen voneinander abhängig. In unserem Beispiel wären das das Alter und der Ticket-Preis. Die Korrelation kann jedoch keine Aussagen darüber treffen welches Merkmal das andere beeinflusst. Es herrscht also nicht unbedingt Kausalität.<br>
Für lineare Beziehungen kann man den "Pearson-Korrelationskoeffizient" bestimmen. Dieser liegt immer zwischen -1 und +1.<br>
Die Berechnung kann auch nur auf Merkmale angewendet werden die Kardinal skaliert sind.<br>
Allgemein wird für die Korrelation die **cor(y~x)-Funktion** verwendet Um die Methode anzugeben kann noch das Argument **method="..."** übergeben werden.<br>
Bestimme hier den Korrelationskoeffizienten des Ticket-Preises (fare) und des Alters (age).

```{r korrelation, exercise = TRUE, exercise.eval = FALSE}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)
```

```{r korrelation-hint}
"cor(y~x,method='...')"
```
```{r korrelation-solution}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)

alter <- titanic_cleanTask$age
gezahlt <- titanic_cleanTask$fare
cor(alter,gezahlt,method="pearson")
```

### Lineare Regression Teil 2
Kommen wir nun zurück zum Beispiel aus dem ersten Teil der linearen Regression. Erzeugen wir zuerst wieder den Plot aus dem ersten Beispiel.<br>
Im Anschluss können wir dann beide Geraden vergleichen.<br>
Für eine bessere Übersicht ist der Scatterplot ausgeschalten

```{r diagrammForLRTwo}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)

alter <- titanic_cleanTask$age
gezahlt <- titanic_cleanTask$fare

plot(gezahlt ~ alter,xlab="Alter der Person",ylab="Ticket Preis", main="Regressionsgerade",pch=20,type="n")

regression <- lm(alter ~ gezahlt)
abline(regression, col="red",lwd=3)
```

Jetzt stellen wir die Regressionsgeradengleichung auf.<br>
Diese hat die Form:
**b = Standardabweichung(y)/Standardabweichung(x) * Korrelation**<br>
**c = Standardabweichung(y)/Standardabweichung(x) * Korrelation * Mittelwert(x) + Mittelwert(y)**<br>
**x** ist in unserem Fall das **Alter**<br>
**y** ist der **Ticket-Preis**
```{r equation}
titanic_cleanTask <- titanic %>%
  filter(!is.na(age)) %>%
  filter(age < 101)
alter <- titanic_cleanTask$age
gezahlt <- titanic_cleanTask$fare

b <- (sd(alter)/sd(gezahlt))*cor(alter,gezahlt,method="pearson")
c <- (sd(alter)/sd(gezahlt))*cor(alter,gezahlt,method="pearson")*mean(gezahlt)+mean(alter)

plot(gezahlt ~ alter,xlab="Alter der Person",ylab="Ticket Preis", main="Regressionsgerade",pch=20,type="n")
abline(a=c,b=b,col="red",lwd = 3)

```
Wie man sieht sind die beiden geraden identisch. Außerdem kann man Folgern, das die Steigung sehr klein aber positiv ist, was bedeutet, das das Alter eine sehr kleine Auswirkung auf den Ticketpreis hat.



### Überprüfung der Hypothesen

## Ergebnispräsentation

## Teaminfos
Benjamin Schur: Varianz,Standardabweichung,Lineare Regression,Kovarianz,Korrelation,Lineare Regression Teil 2

